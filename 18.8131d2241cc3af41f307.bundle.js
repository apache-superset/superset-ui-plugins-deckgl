(window.webpackJsonp=window.webpackJsonp||[]).push([[18],{1140:function(e,t,a){"use strict";a.r(t);var n=a(1),o=a.n(n),i=a(0),r=a.n(i),l=a(945),s=a(946),c=a(948),g=a(947),u=a(958),d=a(949),h=a(952),p=a(1030),m=a(966),f=a(1063),v=a(1005),C=a(981),x=a(1004),y=a(982),b=a(1280),S=a(1136),w=a(1071),_=a(994),M=h.a.count,P=[0,0,0,0],A=[0,255,0,255],R=["minColor","maxColor","colorRange","colorDomain"],k={cellSizePixels:{value:100,min:1},cellMarginPixels:{value:2,min:0,max:5},colorDomain:null,colorRange:C.b,getPosition:{type:"accessor",value:function(e){return e.position}},getWeight:{type:"accessor",value:function(e){return[1,0,0]}},gpuAggregation:!0,aggregation:"SUM"},j=function(e){function t(){return Object(l.a)(this,t),Object(c.a)(this,Object(g.a)(t).apply(this,arguments))}return Object(d.a)(t,e),Object(s.a)(t,[{key:"getShaders",value:function(){var e=Object(b.d)(this.context.gl)?{vs:"#version 300 es\n#define SHADER_NAME screen-grid-layer-vertex-shader\n#define RANGE_COUNT 6\n\nin vec3 positions;\nin vec3 instancePositions;\nin vec4 instanceCounts;\nin vec3 instancePickingColors;\n\nlayout(std140) uniform;\nuniform float opacity;\nuniform vec3 cellScale;\nuniform vec4 minColor;\nuniform vec4 maxColor;\nuniform AggregationData\n{\n  vec4 maxCount;\n} aggregationData;\n\nuniform vec4 colorRange[RANGE_COUNT];\nuniform vec2 colorDomain;\nuniform bool shouldUseMinMax;\n\nout vec4 vColor;\nout float vSampleCount;\n\nvec4 quantizeScale(vec2 domain, vec4 range[RANGE_COUNT], float value) {\n  vec4 outColor = vec4(0., 0., 0., 0.);\n  if (value >= domain.x && value <= domain.y) {\n    float domainRange = domain.y - domain.x;\n    if (domainRange <= 0.) {\n      outColor = colorRange[0];\n    } else {\n      float rangeCount = float(RANGE_COUNT);\n      float rangeStep = domainRange / rangeCount;\n      float idx = floor((value - domain.x) / rangeStep);\n      idx = clamp(idx, 0., rangeCount - 1.);\n      int intIdx = int(idx);\n      outColor = colorRange[intIdx];\n    }\n  }\n  outColor = outColor / 255.;\n  return outColor;\n}\n\nvoid main(void) {\n  vSampleCount = instanceCounts.a;\n\n  float weight = instanceCounts.r ;\n  float maxWeight = aggregationData.maxCount.r;\n  float step = weight / maxWeight;\n  vec4 minMaxColor = mix(minColor, maxColor, step) / 255.;\n\n  vec2 domain = colorDomain;\n  float domainMaxValid = float(colorDomain.y != 0.);\n  domain.y = mix(maxWeight, colorDomain.y, domainMaxValid);\n  vec4 rangeColor = quantizeScale(domain, colorRange, weight);\n\n  float rangeMinMax = float(shouldUseMinMax);\n  vec4 color = mix(rangeColor, minMaxColor, rangeMinMax);\n  vColor = vec4(color.rgb, color.a * opacity);\n  picking_setPickingColor(instancePickingColors);\n\n  gl_Position = vec4(instancePositions + positions * cellScale, 1.);\n}\n",fs:"#version 300 es\n#define SHADER_NAME screen-grid-layer-fragment-shader\n\nprecision highp float;\n\nin vec4 vColor;\nin float vSampleCount;\nout vec4 fragColor;\n\nvoid main(void) {\n  if (vSampleCount <= 0.0) {\n    discard;\n  }\n  fragColor = vColor;\n\n  fragColor = picking_filterColor(fragColor);\n}\n"}:{vs:"#define SHADER_NAME screen-grid-layer-vertex-shader-webgl1\n#define RANGE_COUNT 6\n\nattribute vec3 positions;\nattribute vec3 instancePositions;\nattribute vec4 instanceCounts;\nattribute vec3 instancePickingColors;\n\nuniform float opacity;\nuniform vec3 cellScale;\nuniform vec4 minColor;\nuniform vec4 maxColor;\nuniform float maxWeight;\nuniform vec4 colorRange[RANGE_COUNT];\nuniform vec2 colorDomain;\nuniform bool shouldUseMinMax;\n\nvarying vec4 vColor;\nvarying float vSampleCount;\n\nvec4 quantizeScale(vec2 domain, vec4 range[RANGE_COUNT], float value) {\n  vec4 outColor = vec4(0., 0., 0., 0.);\n  if (value >= domain.x && value <= domain.y) {\n    float domainRange = domain.y - domain.x;\n    if (domainRange <= 0.) {\n      outColor = colorRange[0];\n    } else {\n      float rangeCount = float(RANGE_COUNT);\n      float rangeStep = domainRange / rangeCount;\n      float idx = floor((value - domain.x) / rangeStep);\n      idx = clamp(idx, 0., rangeCount - 1.);\n      int intIdx = int(idx);\n      outColor = colorRange[intIdx];\n    }\n  }\n  outColor = outColor / 255.;\n  return outColor;\n}\n\nvoid main(void) {\n  vSampleCount = instanceCounts.a;\n\n  float weight = instanceCounts.r;\n  float step = weight / maxWeight;\n  vec4 minMaxColor = mix(minColor, maxColor, step) / 255.;\n\n  vec2 domain = colorDomain;\n  float domainMaxValid = float(colorDomain.y != 0.);\n  domain.y = mix(maxWeight, colorDomain.y, domainMaxValid);\n  vec4 rangeColor = quantizeScale(domain, colorRange, weight);\n\n  float rangeMinMax = float(shouldUseMinMax);\n  vec4 color = mix(rangeColor, minMaxColor, rangeMinMax);\n  vColor = vec4(color.rgb, color.a * opacity);\n  picking_setPickingColor(instancePickingColors);\n\n  gl_Position = vec4(instancePositions + positions * cellScale, 1.);\n}\n",fs:"#define SHADER_NAME screen-grid-layer-fragment-shader-webgl1\n\nprecision highp float;\n\nvarying vec4 vColor;\nvarying float vSampleCount;\n\nvoid main(void) {\n  if (vSampleCount <= 0.0) {\n    discard;\n  }\n  gl_FragColor = vColor;\n\n  gl_FragColor = picking_filterColor(gl_FragColor);\n}\n"};return e.modules=["picking"],e}},{key:"initializeState",value:function(){var e=this.getAttributeManager(),t=this.context.gl;e.addInstanced({instancePositions:{size:3,update:this.calculateInstancePositions},instanceCounts:{size:4,transition:!0,accessor:["getPosition","getWeight"],update:this.calculateInstanceCounts,noAlloc:!0}});var a={id:"".concat(this.id,"-aggregator"),shaderCache:this.context.shaderCache},n=this._getMaxCountBuffer(t),o={color:{size:1,operation:y.a.SUM,needMax:!0,maxBuffer:n}};this.setState({model:this._getModel(t),gpuGridAggregator:new x.a(t,a),maxBuffer:n,weights:o}),this._setupUniformBuffer()}},{key:"shouldUpdateState",value:function(e){return e.changeFlags.somethingChanged}},{key:"updateState",value:function(e){Object(u.a)(Object(g.a)(t.prototype),"updateState",this).call(this,e),this._updateUniforms(e),e.changeFlags.dataChanged&&this._processData();var a=this._getAggregationChangeFlags(e);a&&this._updateAggregation(a)}},{key:"finalizeState",value:function(){Object(u.a)(Object(g.a)(t.prototype),"finalizeState",this).call(this);var e=this.state,a=e.aggregationBuffer,n=e.maxBuffer;e.gpuGridAggregator.delete(),a&&a.delete(),n&&n.delete()}},{key:"draw",value:function(e){var t=e.uniforms,a=this.context.gl,n=this.props.parameters,o=void 0===n?{}:n,i=this.props.minColor||P,r=this.props.maxColor||A,l=this.props.colorDomain||[1,0],s=this.state,c=s.model,g=s.maxBuffer,u=s.cellScale,d=s.shouldUseMinMax,h=s.colorRange,p=s.maxWeight,m={minColor:i,maxColor:r,cellScale:u,colorRange:h,colorDomain:l,shouldUseMinMax:d};Object(b.d)(a)?g.bind({target:35345}):m.maxWeight=p,t=Object.assign(m,t),c.draw({uniforms:t,parameters:Object.assign({depthTest:!1,depthMask:!1},o)}),Object(b.d)(a)&&g.unbind()}},{key:"calculateInstancePositions",value:function(e,t){for(var a=t.numInstances,n=this.context.viewport,o=n.width,i=n.height,r=this.props.cellSizePixels,l=this.state.numCol,s=e.value,c=e.size,g=0;g<a;g++){var u=g%l,d=Math.floor(g/l);s[g*c+0]=u*r/o*2-1,s[g*c+1]=1-d*r/i*2,s[g*c+2]=0}}},{key:"calculateInstanceCounts",value:function(e,t){t.numInstances;var a=this.state.aggregationBuffer;e.update({buffer:a})}},{key:"getPickingInfo",value:function(e){var t=e.info,a=(e.mode,t.index);if(a>=0){var n=this.state.gpuGridAggregator.getData("color");t.object=x.a.getAggregationData(Object.assign({pixelIndex:a},n))}return t}},{key:"_getAggregationChangeFlags",value:function(e){var t=e.oldProps,a=e.props,n=e.changeFlags,o=a.cellSizePixels!==t.cellSizePixels||a.cellMarginPixels!==t.cellMarginPixels,i=n.dataChanged||a.aggregation!==t.aggregation,r=n.viewportChanged;return o||i||r?{cellSizeChanged:o,dataChanged:i,viewportChanged:r}:null}},{key:"_getModel",value:function(e){return new S.a(e,Object.assign({},this.getShaders(),{id:this.props.id,geometry:new w.a({drawMode:6,attributes:{positions:new Float32Array([0,0,0,1,0,0,1,1,0,0,1,0])}}),isInstanced:!0,shaderCache:this.context.shaderCache}))}},{key:"_getMaxCountBuffer",value:function(e){return new _.a(e,{byteLength:16,index:0,accessor:{size:4}})}},{key:"_processData",value:function(){var e=this.props,t=e.data,a=e.getPosition,n=e.getWeight,o=M(t),i=new Float64Array(2*o),r=new Float32Array(3*o),l=this.state.weights,s=Object(p.a)(t),c=s.iterable,g=s.objectInfo,u=!0,d=!1,h=void 0;try{for(var m,f=c[Symbol.iterator]();!(u=(m=f.next()).done);u=!0){var v=m.value;g.index++;var C=a(v,g),x=n(v,g),y=g.index;i[2*y]=C[0],i[2*y+1]=C[1],Array.isArray(x)?(r[3*y]=x[0],r[3*y+1]=x[1],r[3*y+2]=x[2]):r[3*y]=x}}catch(e){d=!0,h=e}finally{try{u||null==f.return||f.return()}finally{if(d)throw h}}l.color.values=r,this.setState({positions:i})}},{key:"_setupUniformBuffer",value:function(){var e=this.context.gl;if(Object(b.d)(e)){var t=this.state.model.program.handle,a=e.getUniformBlockIndex(t,"AggregationData");e.uniformBlockBinding(t,a,0)}}},{key:"_shouldUseMinMax",value:function(){var e=this.props,t=e.minColor,a=e.maxColor,n=e.colorDomain,o=e.colorRange;return t||a?(m.a.deprecated("ScreenGridLayer props: minColor and maxColor","colorRange, colorDomain")(),!0):!n&&!o}},{key:"_updateAggregation",value:function(e){var t=this.getAttributeManager();(e.cellSizeChanged||e.viewportChanged)&&(this._updateGridParams(),t.invalidateAll());var a=this.props,n=a.cellSizePixels,o=a.gpuAggregation,i=this.state,r=i.positions,l=i.weights,s=this.context.viewport;l.color.operation=y.a[this.props.aggregation.toUpperCase()]||y.a.SUM;var c=!1,g=null;this.context.viewport instanceof f.a?c=!0:(c=!1,g=s.pixelProjectionMatrix);var u=this.state.gpuGridAggregator.run({positions:r,weights:l,cellSize:[n,n],viewport:s,changeFlags:e,useGPU:o,projectPoints:c,gridTransformMatrix:g}),d=u.color.maxData&&Number.isFinite(u.color.maxData[0])?u.color.maxData[0]:0;this.setState({maxWeight:d}),t.invalidate("instanceCounts")}},{key:"_updateUniforms",value:function(e){var t=e.oldProps,a=e.props,n=e.changeFlags,o={};if(R.some((function(e){return t[e]!==a[e]}))&&(o.shouldUseMinMax=this._shouldUseMinMax()),t.colorRange!==a.colorRange&&(o.colorRange=Object(C.a)(a.colorRange,Float32Array,255)),t.cellMarginPixels!==a.cellMarginPixels||t.cellSizePixels!==a.cellSizePixels||n.viewportChanged){var i=this.context.viewport,r=i.width,l=i.height,s=this.props,c=s.cellSizePixels,g=s.cellMarginPixels,u=c>g?g:0;o.cellScale=new Float32Array([(c-u)/r*2,-(c-u)/l*2,1])}this.setState(o)}},{key:"_updateGridParams",value:function(){var e=this.context.viewport,t=e.width,a=e.height,n=this.props.cellSizePixels,o=this.context.gl,i=Math.ceil(t/n),r=Math.ceil(a/n),l=i*r,s=4*l*4,c=this.state.aggregationBuffer;c&&c.delete(),c=new _.a(o,{byteLength:s,accessor:{size:4,type:5126,divisor:1}}),this.state.weights.color.aggregationBuffer=c,this.setState({numCol:i,numRow:r,numInstances:l,aggregationBuffer:c})}}]),t}(v.a);j.layerName="ScreenGridLayer",j.defaultProps=k;var D=a(25),O=a(976),z=a(975),U=a(956),N=a(962),E=a(964),F=a(968);function G(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function I(){return(I=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e}).apply(this,arguments)}function B(e){return o.a.createElement("div",{className:"deckgl-tooltip"},o.a.createElement(E.a,{label:Object(D.b)("Longitude and Latitude")+": ",value:e.coordinate[0]+", "+e.coordinate[1]}),o.a.createElement(E.a,{label:Object(D.b)("Weight")+": ",value:""+e.object.weight}))}function T(e,t,a,n,o,i,r){const l=e,s=l.color_picker;let c=t.data.features.map(e=>I({},e,{color:[s.r,s.g,s.b,255*s.a]}));if(l.js_data_mutator){const e=Object(U.a)(l.js_data_mutator);c=e(c)}return null!=r&&r.forEach(e=>{c=c.filter(t=>e(t))}),new j(I({id:"screengrid-layer-"+l.slice_id,data:c,pickable:!0,cellSizePixels:l.grid_size,minColor:[s.r,s.g,s.b,0],maxColor:[s.r,s.g,s.b,255*s.a],outline:!1,getWeight:e=>e.weight||0},Object(N.a)(l,n,B)))}a.d(t,"getLayer",(function(){return T}));const V={formData:r.a.object.isRequired,payload:r.a.object.isRequired,setControlValue:r.a.func.isRequired,viewport:r.a.object.isRequired,onAddFilter:r.a.func,width:r.a.number.isRequired,height:r.a.number.isRequired},W={onAddFilter(){}};class L extends o.a.PureComponent{constructor(e){super(e),G(this,"containerRef",o.a.createRef()),G(this,"setTooltip",e=>{const{current:t}=this.containerRef;t&&t.setTooltip(e)}),this.state=L.getDerivedStateFromProps(e),this.getLayers=this.getLayers.bind(this),this.onValuesChange=this.onValuesChange.bind(this)}static getDerivedStateFromProps(e,t){if(t&&e.payload.form_data===t.formData)return null;const a=e.payload.data.features||[],n=a.map(e=>e.__timestamp),o=e.payload.form_data.time_grain_sqla||e.payload.form_data.granularity||"P1D",{start:i,end:r,getStep:l,values:s,disabled:c}=Object(z.a)(n,o),{width:g,height:u,formData:d}=e;let{viewport:h}=e;var p;return d.autozoom&&(h=Object(F.a)(h,{width:g,height:u,points:(p=a,p.map(e=>e.position))})),{start:i,end:r,getStep:l,values:s,disabled:c,viewport:h,selected:[],lastClick:0,formData:e.payload.form_data}}onValuesChange(e){this.setState({values:Array.isArray(e)?e:[e,e+this.state.getStep(e)]})}getLayers(e){const t=[];return e[0]===e[1]||e[1]===this.end?t.push(t=>t.__timestamp>=e[0]&&t.__timestamp<=e[1]):t.push(t=>t.__timestamp>=e[0]&&t.__timestamp<e[1]),[T(this.props.formData,this.props.payload,this.props.onAddFilter,this.setTooltip)]}render(){const{formData:e,payload:t,setControlValue:a}=this.props;return o.a.createElement("div",null,o.a.createElement(O.a,{ref:this.containerRef,aggregation:!0,getLayers:this.getLayers,start:this.state.start,end:this.state.end,getStep:this.state.getStep,values:this.state.values,disabled:this.state.disabled,viewport:this.state.viewport,width:this.props.width,height:this.props.height,mapboxApiAccessToken:t.data.mapboxApiKey,mapStyle:e.mapbox_style,setControlValue:a,onValuesChange:this.onValuesChange,onViewportChange:this.onViewportChange}))}}L.propTypes=V,L.defaultProps=W;t.default=L}}]);